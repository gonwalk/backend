# 1.Zookeeper是什么

官方文档上这么解释zookeeper，它是一个开源的、分布式程序协调服务，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理、分布式锁等。

zookeeper，就像它的名字一样，是一个动物园管理员，它是用来管理 hadoop（大象）、Hive(蜜蜂)、pig(小 猪)的管理员， Apache Hbase 和 Apache Solr 的分布式集群都用到。

简单来说，zookeeper=文件系统+监听通知机制。



## 1.1 文件系统

Zookeeper维护一个类似文件系统的数据结构：

![zookeeper结构](https://oscimg.oschina.net/oscnet/9360a80fec827de30e216e324edee8a9e85.jpg "zookeeper结构示意")

每个子目录项如 NameService 都被称作为 znode(目录节点)，和文件系统一样，用户能够自由的增加、删除znode，在一个znode下增加、删除子znode，唯一的不同在于znode是可以存储数据的。

有四种类型的znode：
 
（1）PERSISTENT-持久化目录节点

客户端与zookeeper断开连接后，该节点依旧存在

（2）PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点

客户端与zookeeper断开连接后，该节点依旧存在，只是zookeeper给该节点名称进行顺序编号

（3）EPHEMERAL-临时目录节点

客户端与zookeeper断开连接后，该节点被删除

（4）EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点

客户端与zookeeper断开连接后，该节点被删除，只是zookeeper给该节点名称进行顺序编号

## 1.2 监听通知机制

客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端。

# 2.Zookeeper能做什么

zookeeper功能非常强大，可以实现诸如分布式应用配置管理、统一命名服务、状态同步服务、集群管理等功能。


## 2.1 配置管理


在应用中除了代码外，还有一些各种配置，比如数据库连接等。一般都是使用配置文件的方式，在代码中引入这些配置文件。当只有一种配置，只有一台服务器，并且不经常修改的时候，使用配置文件是一个很好的做法。但是如果配置非常多，有很多服务器都需要这个配置，比如现在互联网行业主推的将程序分布式地部署在多台机器上，如果这种情况要改变程序的配置文件，需要逐台机器去修改，非常麻烦。

现在把这些配置全部放到zookeeper上去，保存在 zookeeper 的某个目录节点中，然后所有相关应用程序对这个目录节点进行监听，一旦配置信息发生变化，每个应用程序就会收到 zookeeper 的通知，然后从 zookeeper 获取新的配置信息应用到系统中。

Zookeeper使用 Zab 这种一致性协议来保证一致性。现在有很多开源项目使用 Zookeeper 来维护配置信息，比如在 HBase 中，客户端通过连接一个 Zookeeper，获得必要的 HBase 集群的配置信息，然后进一步操作。还有在开源的消息队列 Kafka中，也使用Zookeeper来维护broker的信息。在 Alibaba开源的 SOA 框架Dubbo 中也广泛的使用 Zookeeper 管理一些配置来实现服务治理。

## 2.2 命名服务

名字服务这个就很好理解了。比如为了通过网络访问一个系统，需要知道对方的 IP 地址，但是 IP 地址对人非常不友好，这个时候就需要使用域名来访问。但是计算机是不认识域名的。怎么办呢？

如果每台机器里都备有一份域名到IP地址的映射，这个倒是能解决一部分问题，但是如果域名对应的 IP 发生变化了又该怎么办呢？于是有了DNS这个东西。这样只需要访问一个大家熟知的(known)的服务点，它就会告诉你这个域名对应的 IP 是什么。在我们的应用中也会存在很多这类问题，特别当服务特别多的时候，如果在本地保存服务的地址将非常不方便，但是当访问一个大家都熟知的访问服务点，在这里提供统一的入口，那么维护起来将方便得多，而zookeeper的命名服务就是起到这个作用。

## 2.3 分布式锁

Zookeeper是一个分布式协调服务，这样就可以利用 Zookeeper 来协调多个分布式进程之间的活动。比如在一个分布式环境中，为了提高可靠 性，需要在集群的每台服务器上都部署着同样的服务。但是，如果集群中的每个服务器都同时进行的话，那相互之间就要协调，编程起来将非常复杂。而如果只让一个服务进行操作，那又存在单点（各个服务器上数据不一致）问题。

通常还有一种做法就是使用分布式锁，在某个时刻只让一个服务去干活，当这台服务出现问题的时候释放锁，立即 fail over 到另外的服务。很多分布式系统中都是这么做，这种设计有一个更好听的名字叫 Leader Election(leader 选举)。比如 HBase 的 Master 就是采用这种机制。但要注意的是分布式锁跟同一个进程的锁还是有区别的，所以使用的时候要比同一个进程里的锁更谨慎地去使用。

# 2.4 集群管理

在分布式的集群中，经常会由于各种原因，比如硬件故障、软件故障、网络问题，有些节点会进进出出。有新的节点加入进来，也有老的节点退出集群。这个时候，集群中其他机器需要感知到这种变化，然后根据这种变化做出对应的决策。比如对于一个分布式存储系统，有一个中央控制节点负责存储的分配，当有新的存储进来的时候需要根据集群目前的状态来分配存储节点。这个时候就需要动态地感知到集群的状态。还有，比如在一个分布式的 SOA 架构中，服务是一个集群提供的，当消费者访问某个服务时，就需要采用某种机制发现现在有哪些节点可以提供该服务(这也称之为服务发现，比如 Alibaba 开源的 SOA 框架 Dubbo 就采用了 Zookeeper 作为服务发现的底层机制)。还有开源的 Kafka 队列就 采用了 Zookeeper 作为 Cosnumer 的上下线管理。

# 参考

Zookeeper入门看这篇就够了：https://my.oschina.net/u/3796575/blog/1845035

ZooKeeper详解：https://zhuanlan.zhihu.com/p/72902467