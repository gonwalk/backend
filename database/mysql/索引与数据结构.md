
# 索引与数据结构

索引是帮助MySQL高效获取数据的排好序的数据结构。

常用的索引的数据结构有：
```markdown
- B+树
- 红黑树：Java JDK1.8及之后的HashMap被优化为红黑树数据结构
- Hash
- 二叉树
- B-树
```


## 索引的缺点

虽然使用索引有很多好处，但过多的使用索引将会造成滥用。因此索引也会有它的缺点：

```markdown
- 虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件。
- 建立索引会占用磁盘空间的索引文件。一般情况这个问题不太严重，但如果在一个大表上创建了多种组合索引，索引文件会膨胀很快。

```

索引只是提高效率的一个因素，如果MySQL有大数据量的表，就需要花时间研究建立最优秀的索引，或优化查询语句。

## InnoDb存储引擎索引概述

InnoDB存储引擎支持几种常见的索引：
- B+树索引
- 全文索引
- 哈希索引

InnoDB存储引擎支持的哈希索引是自适应的，InnoDB存储引擎会根据表的使用情况自动为表生成哈希索引，不能认为干预是否在一张表中生成哈希索引的生成。

B+树索引就是传统意义上的索引，这是关系型数据库系统中查找最为常用和最为有效的索引。B+树索引的构造类似于二叉树，根据键值快速找到数据。

- 注意：B+树中的B不是代表二叉（binary）树，而是代表平衡（balance），因为B+树是从最早的平衡二叉树演化而来的，但是B+树不是一个二叉树。 

## 数据结构与算法

B+树索引是在数据库中使用最为频繁的一种索引。

### 二叉查找树和平衡二叉树

B+树是通过二叉查找树，再由平衡二叉树，B树演化而来。

#### 二叉查找树

在二叉查找树中，左子树的键值总是小于根的键值，右子树的键值总是大于根的键值。因此可以通过中序遍历得到（二叉查找树）键值的排序输出。

一个数字序列对应的二叉查找树可以任意构造，构造出的结构可能是多样的，而查询效率也会有所差别。因此若想最大性能低构造一颗二叉查找树，需要这颗二叉查找树是平衡的，这就是平衡二叉树，或称为AVL树。

#### 平衡二叉树

平衡二叉树定义：
1. 满足二叉查找树的定义；
2. 满足任何节点的两个子树的高度最大差为1。

平衡二叉树的查找性能是比较高的，但不是最高的，只是接近最高性能。性能最好的是最优二叉树，但最优二叉树的建立和维护需要大量的操作，因此，用户一般只需建立一颗平衡二叉树即可。

维护一颗平衡二叉树的代价是很大的，通常需要一次或多次左旋和右旋来得到插入或更新后树的平衡性。

对于图1中的平衡树，当插入9时，需要做图2所示的变动。

![图1](database/pictures/二叉查找树.png "平衡查找树")

![图2](database\pictures\插入键值9，平衡二叉树变化.png "插入键值9后平衡二叉树变化")

![图3](database\pictures\需多次旋转的平衡二叉树.png "需要多次旋转的二叉树")

向一颗平衡二叉树插入、删除、更新一个新的节点后，需要通过左旋或者右旋来保持新的平衡状态，因此对一颗平衡树的维护是有一定开销的。平衡二叉树多用于内存结构对象中，因此为何的开销相对较小。

## B+树

B+树由B树和索引顺序访问方法（ISAM，这是MyISAM查询引擎最初参考的数据结构）演化而来，但是在现实使用过程中几乎没有使用B树的情况了。

B+树是为磁盘或其他直接存取辅助设备设计的一种平衡查找树。在B+树中，所有记录节点都是按照键值的大小顺序存放在同一层叶子节点上，由各个叶子节点指针进行连接。

## B+树索引

B+树索引的本质就是B+树在数据库中的实现。B+树在数据库中有一个特点是高扇出性，因此在数据库中，B+树的高度一般都在2~4层，这也就是说查找某一个键值的行记录时最多只需要2到4次IO。当前一般的机械硬盘每秒至少可以做100次IO，2~4次的IO意味着查询时间只需0.02 ~ 0.04秒。

数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index），不管是哪种索引，其内部都是B+树，即高度平衡的，叶子节点存放着所有的数据。聚集索引与辅助索引不同的地方在于，叶子节点存放的是否是一整行的信息。

### 聚集索引（叶子节点存放的是行记录数据）

聚集索引按照每张表的主键构造一颗B+树，同时叶子节点中存放的即为整张表的行记录数据。每张表只能有一个聚集索引。

#### 聚集索引组织架构

InnoDB存储引擎是索引组织表，即表中的数据按照主键顺序存放。而聚集索引就是按照每张表的主键构造一颗B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。

由于实际的数据页只能按照一颗B+树进行排序，因此每张表只能有一个聚集索引。在多数情况下，查询优化器倾向于采用聚集索引，因为聚集索引能够在B+树索引的叶子节点上直接找到数据。由于定义了数据的（主键）逻辑顺序，聚集索引能够非常快地访问针对范围内的查询。

数据页上存放的是完成的每页的记录，而在非数据页的索引页中，存放的仅仅是键值以及指向数据页的偏移量，而不是一个完整的行记录。

#### 聚集索引特点

聚集索引按照顺序物理地存储数据，其存储顺序并不是物理上连续的，而是逻辑（主键）上连续的。其中有两点原因：其一是页通过双向链表进行链接，并按照主键的顺序进行排序；其二是每个页中的记录也是通过双向链表进行维护的，物理存储上可以同样不按照主键存储。

聚集索引的另一个好处是，它对于主键的排序查找（order by）和范围查找（大于>或小于<某个范围）速度非常快。叶子节点的数据就是用户所要查询的数据。


通过explain关键字获取mysql语句的执行计划（execute plan），及执行过程的解释。如：
mysql> explain
mysql> select * from student order by id limit 3;


### 辅助索引（也称为非聚集索引，叶子节点存放行数据的指针）

辅助索引（Secondary Index，也称为非聚集索引），叶子节点并不存放行记录的数据，而是指向具体行数据的指针。

辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引去查找数据时，InnoDB存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后通过主键索引找到完整的行记录。

### 聚集索引与非聚集索引的区别
```
聚集索引的叶子节点存放的是具体的行数据，一张表只能有一个聚集索引。
非聚集索引的叶子节点存放的是指向行数据的指针，一张表可以有多个聚集索引。
```

