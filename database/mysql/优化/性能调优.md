# 性能调优

InnoDB存储引擎的性能问题：
```
选择合适的CPU
内存的重要性
硬盘对数据库性能的影响
合理地设置RAID
操作系统的选择
不同文件系统对数据库的影响
选择合适的基准测试工具
```


## 选择合适的CPU核数
 
数据库的应用类型，一般而言，可以分为两大类：OLTP（Online Transaction Processing，在线事务处理）和OLAP（Online Analytical Processing，在线分析处理）。OLAP多用于数据仓库货数据集市中，一般需要执行复杂的SQL语句来进行查询；OLTP多用于日常的事务处理应用中，如银行交易、在线商品交易、Blog、网络游戏等应用。

InnoDB存储引擎一般都应用于OLTP的数据库应用，这种应用的特点如下：
```
用户操作的并发量大；
事务处理的时间一般比较短；
查询的语句较为简单，一般都走索引；
复杂的查询较少。
```

OLTP的数据库应用本身对CPU的要求并不高，复杂的查询需要执行比较、排序、连接等耗CPU的操作，这些操作在OLTP中较少发生。因此，OLAP是CPU密集型的操作，而OLTP是IO密集型的操作。

InnoDB存储引擎的后台操作都是在一个单独的master thread中完成的，因此并不能很好地支持多核的应用。InnoDB的版本在1.1及更高的版本中，已经支持多核的CPU，可以通过修改参数innodb_read_io_threads和innodb_write_io_threads增大IO的线程，这样能更充分地利用CPU的多核性能。

一般选择多核的64为操作系统。

## 内存

内存的大小是最能直接反映数据库的性能。InnoDB存储引擎既缓存数据，又缓存索引，并且将它们缓存于一个很大的缓冲池中，即InnoDB Buffer Pool。因此，内存的大小直接影响数据库的性能。

如何判断当前数据库的内存是否已经达到瓶颈？可以通过查看当前服务器的状态，比较物理磁盘的读取和内存读取的比例来判断缓冲池的命中率，通常InnoDB存储引擎的缓冲池的命中率不应该小于99%，如：
```mysql
mysql> SHOW GLOBAL STATUS LIKE 'innodb%read%'\G;
......
```

即使缓冲池的大小已经大于数据库文件的大小，这也并不意味着没有磁盘操作。数据库的缓冲池只是一个用来存放热点的区域，后台的线程还负责将脏页异步地写入到磁盘。此外，每次事务提交时，还需要将日志写入重做日志文件。

## 硬盘对数据库性能的影响

### 传统机械硬盘

目前大多数数据库使用的都是传统的机械硬盘，在服务器领域一般使用SAS或SATA接口的硬盘。

机械硬盘有两个重要指标：一个是寻道时间，另一个是转速。传统机械硬盘最大的问题在于读写磁头，读写磁头的设计使磁盘可以随机访问。但是，机械磁盘的访问需要消耗长时间的磁头旋转和定位来查找，因此顺序访问的速度要高于随机访问。

通常，可以将多块机械硬盘组成RAID来提高数据库的性能，也可以将数据文件分布在不同硬盘上来达到访问负载的均衡。

### 固态硬盘

固态硬盘，其内部是由闪存（Flash Memory）组成。闪存具有低延迟、低功耗、防震性等特点。企业级应用一般使用固态硬盘，通过并联多块闪存来进一步提高数据传输的吞吐量。

闪存没有传统的机械硬盘的读写磁头，不需要耗费大量时间的磁头旋转和定位来查找数据，所以固态硬盘可以提供一致的随机访问时间消耗，并可以快速地进行数据读写和定位。

闪存中的数据是不可以更新的，只能通过扇区（sector）的覆盖重写，而在覆盖重写之前，需要执行非常耗时的擦除（erase）操作。

## 合理地设置RAID

### RAID类型

RAID（Redundant Array of Independent Disks，独立磁盘冗余数组）的基本思想是：把多个相对便宜的磁盘组合起来，组成一个磁盘数组，使性能达到甚至超过一个价格昂贵、容量巨大的磁盘。


## 基准测试工具

基准测试工具可以用来对数据库或操作系统调优后的性能进行对比。常用的基准测试工具有：sysbench和mysql-tpcc。

### sysbench

sysbench是一个模块化的、跨平台的多线程基准测试工具，主要用于测试各种不同系统参数下的数据库负载情况。主要包括以下几种测试方式：
```
CPU性能
磁盘IO性能
调度程序性能
内存分配及传输速度
POSIX线程性能
数据库OLTP基准测试
```

### mysql-tpcc

TPC（Transaction Processing Performance Council，事务处理性能协会）是一个用来评价大型数据库系统软硬件性能的非盈利性组织。TPC-C是TPC协会制定的，用来测试典型的复杂OLTP（在线事务处理）系统的性能。目前学术界和工业界普遍采用TPC-C来评价OLTP应用的性能。
