
# 1 如何搭建高性能、高可用MySQL架构

基于MySQL的主从复制机制。

## 1.1 主从复制原理

MySQL内置有bin log和relay log两类日志文件，主数据库会将所有的DML操作记录在bin log日志里面，之后bin log里面的内容会通过网络发送给从数据库里的relay log日志中，从数据库通过解析relay log中的记录对主数据库进行一个备份操作。

## 1.2 数据备份方式

注意：不要把主从同步作为数据库备份的唯一操作，如果出现网络异常，可能出现网络延迟导致备份失败。可以结合如下三种方式进行数据备份：
```
（1）数据库中数据采用主从复制进行备份；
（2）将数据库中的数据进行本地物理备份；
（3）定期将一些物理文件备份到云端。
```

## 1.3 如何保证高性能——MySQL高性能架构设计

海量请求会使数据库的操作，处于长期的高并发环境之中，为了保证高并发环境下的数据安全，需要设计数据库的事务隔离级别，或者采用加锁的机制。但并不是所有的数据操作都会产生安全性问题，仅仅是对数据的写操作才可能导致各种并发问题，而读操作是不会产生安全性问题的，且读操作是远远大于写操作。


### 1.3.1 读写分离

为了保证数据库的性能，可以将大部分的操作汇聚在从数据库上，而降相对较少的写操作集中在主数据库里边，这就是常说的读写分离技术。

采用读写分离技术后，不需要对所有的读写请求都进行线程安全控制，而只需要对相对较少的（作用在主数据库上的）写请求进行事务操作或加锁等安全处理即可。所以，读写分离可以大幅提高系统的数据访问性能。

可以在主从同步时，甚至对多个从数据库进行冗余备份，然后用冗余的多个从数据库去负载大量的读请求。

### 1.3.2 分库分表——属于水平拆分

在水平方向上，如果是表的容量不够了，可以对表进行拆分，即分表操作；如果是库的容量不够，可以对库进行拆分，也即是分库。

分库分表操作的底层实现原理，实际上是使用算法将对同一对象的写操作映射到多个数据库里形成一对多的关系。读操作也是一样，在分库分表之后，读操作也需要从拆分后的数据库或者表里，进行数据的拼接操作。

分库分表和读写分离，都可以使用MyCat进行操作。分库分表属于水平拆分。

#### 1.3.2.1 使用冗余提升效率——相当于垂直拆分

对于大部分的读操作，可以通过冗余来提升效率。如果将一份数据冗余成多分（可以采用集群进行数据备份），那么就可以用多分数据进行并发的负载均衡。比如，有100个读请求去访问记录a，现在将其冗余为两份存放在不同的机器（即主从分离中的从数据库）上，那么每个机器上只需要承载50个线程的读请求并发量。采用冗余操作，可以提高单节点的性能。

如果项目采用微服务，或者每个库表里面的数据量不大，可以使用垂直拆分的方式，让每个微服务独立地存储到一个数据库里面。也可以将水平拆分和垂直拆分结合起来。

#### 1.3.2.2 吹瓶拆分和垂直拆分

简单地说，水平拆分和垂直拆分的主要区别如下：
```
水平拆分：是对不同的数据进行拆分，如分库分表，分库分表后不同的库表中存放的是不同的数据。
垂直拆分：是对相同数据的拆分（备份）。
```

### 1.3.3 数据库优化

对数据库的主要优化方向，如下：
```
1.字段类型选择
2.数据库缓存
3.关闭无用服务
4.数据库参数调优
5.选取合适的存储引擎
6.SQL语句编写
7.索引处理
```

#### 1.3.3.1 SQL执行计划

对于SQL语句和索引的优化处理，可以使用explain语句查看SQL执行计划，根据执行计划进行相应的参数调优。

### 1.3.3.2 慢查询日志

如果有上百上千行SQL，如果发现其中执行比较慢的SQL语句呢？可以使用慢查询日志，或者mysqldumpslow等一些慢查询工具，可以直接找到性能较低的SQL语句。

## 1.4 如何保证高可用性——MySQL高可用性架构设计

通常可以使用MyCat进行读写分离、分库分表来保证数据的高并发性。但是如果MyCat在部署的时候，只使用一台机器，当服务挂掉（单点故障），就会导致MySQL服务不可用。如何保证MySQL服务的高可用性呢？通常采用集群技术。

### 1.4.1 心跳机制和虚拟IP防止单点故障

可以采用去中心化的集群设计架构。比如，可以部署两个完全一样的MyCat服务，分别部署在不同的节点上，并让这两个MyCat服务共同维护一个虚拟IP（即这个虚拟IP可以指向两个MyCat中的任何一个）。在初始化阶段，根据IP选举策略选中其中的一个MyCat作为临时的Master，然后通过心跳机制和另一个MyCat进行通信。之后，如果当前的Master挂掉，那么心跳机制就会将虚拟IP动态地改为另一个MyCat的服务地址，并将那个临时存活的MyCat设为新的Master，接替分库分表以及读写分离等职责。

当部署了多个（MyCat）机器后，使用这种集群的方式，选举策略和心跳机制可以保证至少有一个服务可用，从而可以有效地防止单点故障问题的出现。

在实际项目中，通常可以使用zookeeper、HAProxy、Keepalived等组件，来实现选举、心跳、虚拟IP等功能。

### 1.4.2 海量请求处理方案

对于海量请求，可以使用限流、削峰填谷（可以使用消息队列）、缓存等策略，将数据存放到关系型数据库中。

对于超大海量请求，例如PB级或者日处理上亿的数据，可以使用非关系型数据库以及相关大数据技术进行处理。

